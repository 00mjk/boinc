<?php
// ; $Id$

/**
 * @file
 * Enables BOINC team forum functionality.
 *
 * Allows forums to be created for any BOINC team
 */


/*  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *
 * Includes that provide supporting functions
 *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  */

require_once('includes/boincteam_forum.forms.inc');
//require_once('includes/boincteam_forum.helpers.inc');


/*  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *
 * Hooks into core modules
 *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  */

/**
 * Implementation of hook_menu()
 */
function boincteam_forum_menu() {
  $items = array();

  return $items;
}

/**
* Implementation of hook_views_api().
*/
function boincteam_forum_views_api() {
  return array(
    'api' => 2.0,
    'path' => drupal_get_path('module', 'boincteam_forum')
  );
}

/**
 * Implementation of hook_perm()
 */
function boincteam_forum_perm() {
  return array('manage boincteam forum');
}


/*  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *
 * BOINC team forum functions
 *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  */

/*
 * Load the current user's team forums, if any exist
 */
function boincteam_forum_is_public($tfid) {
  return db_result(db_query("
    SELECT public FROM {boincteam_forum} WHERE tfid=%d", $tfid
  ));
}

/*
 * Load the current user's team forums, if any exist
 */
function boincteam_forum_list() {
  global $user;
  $account = user_load($user->uid);
  $team_forums = array();
  if ($account->team) {
    // Load any team forum objects for the user's team
    $result = db_query("
      SELECT tfid, nid, title, description, created, updated, public,
        min_time_between_posts, min_total_credit_to_post, min_avg_credit_to_post
      FROM {boincteam_forum} WHERE nid=%d", $account->team
    );
    $row = 0;
    while ($team_forum = db_fetch_object($result)) {
      
      $team_forum->link = url("community/teams/{$account->team}/forum/{$team_forum->tfid}");
      $team_forum->zebra = $row % 2 ? 'even' : 'odd';
      $team_forum->new_topics = 0; // TODO: Track user views of team topics
      $team_forum->new_text = '';
      $team_forum->new_url = '';
      $team_forum->num_topics = db_result(db_query("
        SELECT COUNT(nid) FROM {boincteam_forum_node}
        WHERE tfid = %d",
        $team_forum->tfid
      ));
      $team_forum->num_posts = db_result(db_query("
        SELECT SUM(ncs.comment_count) + COUNT(ncs.nid)
        FROM {boincteam_forum_node} bfn
        JOIN {node_comment_statistics} ncs ON ncs.nid = bfn.nid
        JOIN {node} n ON n.nid = ncs.nid
        WHERE bfn.tfid = %d AND n.status = 1",
        $team_forum->tfid
      ));
      $last_post = new stdClass();
      $last_post->timestamp = db_result(db_query("
        SELECT ncs.last_comment_timestamp FROM {node} n
        INNER JOIN {boincteam_forum_node} bfn
        INNER JOIN {node_comment_statistics} ncs ON n.nid = ncs.nid
        WHERE n.status = 1 AND bfn.tfid = %d
        ORDER BY ncs.last_comment_timestamp DESC
        LIMIT 1",
        $team_forum->tfid
      ));
      $team_forum->last_reply = theme('forum_submitted', $last_post);
      $team_forums[$team_forum->tfid] = $team_forum;
      $row++;
    }
  }
  return $team_forums;
}

/*
 * Load a team forum by ID
 */
function boincteam_forum_load($tfid) {
  // Load any team forum objects for the user's team
  $result = db_query("
    SELECT tfid, nid, title, description, created, updated, public,
      min_time_between_posts, min_total_credit_to_post, min_avg_credit_to_post
    FROM {boincteam_forum} WHERE tfid=%d", $tfid
  );
  return db_fetch_object($result);
}


/*  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *
 * Pane content for panels
 *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  */

/**
 * Create team forum form
 */
function boincteam_forum_create_form_panel() {
  $output = '';
  $output .= '<h2 class="pane-title">' . t('Create team message board') . '</h2>';
  $output .= drupal_get_form('boincteam_forum_create_form');
  
  return $output;
}

/**
 * General info about team forums
 */                                         
function boincteam_forum_topic_overview_panel($nid = NULL) {
  $output = '';
  $output .= '<h2 class="pane-title">' . t('About message boards') . '</h2>';
  $output .= '<div>';
  if ($nid) {
    $team = node_load($nid);
    $output .= '<p>' . t('You may create a message board for use by @team',
      array('@team' => $team->title)) . ':</p>';
  }
  else {
    $output .= '<p>' . t('This is a team-only message board') . ':</p>';
  }
  $output .= '<ul>';
  $output .= '  <li>' . t('Only members may post') . '</li>';
  $output .= '  <li>' . t('Only members may read (optional)') . '</li>';
  $output .= '  <li>' . t('Founder & Team Admins have moderator privileges') .
    '</li>';
  $output .= '</ul>';
  $output .= '</div>';
  return $output;
}

/**
 * Edit team forum form
 */
function boincteam_forum_edit_form_panel($tfid) {
  $team_forum = boincteam_forum_load($tfid);
  $output = '';
  $output .= '<h2 class="pane-title">' . t('Edit message board') . ': ' . 
    $team_forum->title . '</h2>';
  $output .= drupal_get_form('boincteam_forum_edit_form', $tfid);
  
  return $output;
}
